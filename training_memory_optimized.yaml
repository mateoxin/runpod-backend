job: extension
config:
  name: "Matt_flux_lora_MEMORY_OPTIMIZED"    # Wersja zoptymalizowana pod kÄ…tem pamiÄ™ci

  process:
    - type: sd_trainer
      training_folder: "/workspace/output"
      device: cuda:0
      trigger_word: "Matt"

      # LoRA network - ZREDUKOWANE dla oszczÄ™dnoÅ›ci pamiÄ™ci
      network:
        type: lora
        linear: 8                         # ğŸ”½ ZREDUKOWANE z 20 â†’ 8 (drastyczna oszczÄ™dnoÅ›Ä‡ pamiÄ™ci)
        linear_alpha: 8                   # Alpha = rank 
        network_dropout: 0.1              # ZwiÄ™kszone dropout dla regularyzacji
        transformer_only: true

      # Zapisywanie - konserwatywne ustawienia
      save:
        dtype: float16
        save_every: 500                   # ğŸ”½ Rzadziej zapisuj (oszczÄ™dnoÅ›Ä‡ I/O)
        max_step_saves_to_keep: 2         # ğŸ”½ Mniej checkpointÃ³w (oszczÄ™dnoÅ›Ä‡ dysku)
        push_to_hub: false
        save_format: "safetensors"
        save_model_as: "safetensors"
        save_precision: "fp16"

      # Dataset - ZOPTYMALIZOWANE Å›cieÅ¼ki
      datasets:
        - folder_path: "/workspace/training_data"
          caption_ext: "txt"
          caption_dropout_rate: 0.1       # ZwiÄ™kszone dla regularyzacji
          shuffle_tokens: false
          cache_latents_to_disk: true     # âœ… Kluczowe dla oszczÄ™dnoÅ›ci RAM
          resolution: [512]               # ğŸ”½ TYLKO najniÅ¼sza rozdzielczoÅ›Ä‡!
          random_crop: false
          center_crop: true
          flip_p: 0.0
          pin_memory: false               # ğŸ”½ WyÅ‚Ä…czone dla oszczÄ™dnoÅ›ci RAM
          num_workers: 1                  # ğŸ”½ Mniej workers = mniej RAM
          persistent_workers: false       # ğŸ”½ WyÅ‚Ä…czone dla oszczÄ™dnoÅ›ci

      # TRENING - MAKSYMALNE OSZCZÄ˜DNOÅšCI PAMIÄ˜CI
      train:
        batch_size: 1                     # âœ… Minimalna wartoÅ›Ä‡
        steps: 500                        # ğŸ”½ KrÃ³tszy trening dla testu
        gradient_accumulation_steps: 2    # âœ… Symuluje wiÄ™kszy batch bez RAM
        train_unet: true
        train_text_encoder: false         # âœ… WyÅ‚Ä…czone dla oszczÄ™dnoÅ›ci
        gradient_checkpointing: true      # âœ… Kluczowe dla oszczÄ™dnoÅ›ci
        noise_scheduler: "flowmatch"
        optimizer: "adamw8bit"            # âœ… 8-bit optimizer
        lr: 0.0001                        # Standardowy learning rate
        lr_scheduler: "constant"
        # Precyzja - agresywna oszczÄ™dnoÅ›Ä‡
        dtype: "fp16"                     # ğŸ”½ fp16 zamiast bf16 (mniej RAM)
        mixed_precision: "fp16"           # ğŸ”½ fp16 dla wszystkiego
        # EMA - wyÅ‚Ä…czone dla oszczÄ™dnoÅ›ci
        # ema_config:                     # ğŸ”½ CaÅ‚kowicie wyÅ‚Ä…czone
        #   use_ema: false
        # Podstawowe ustawienia
        max_grad_norm: 1.0
        skip_cache_check: true
        enable_xformers: true             # âœ… Memory-efficient attention
        compile_unet: false               # WyÅ‚Ä…czone dla stabilnoÅ›ci
        dataloader_num_workers: 1         # ğŸ”½ Minimalne workers
        seed: 42
        noise_offset: 0.02                # ğŸ”½ Zmniejszone

      # Model - MAKSYMALNE OSZCZÄ˜DNOÅšCI
      model:
        name_or_path: "black-forest-labs/FLUX.1-dev"
        is_flux: true
        quantize: true                    # âœ… Kluczowe
        low_vram: true                    # ğŸ”½ WÅÄ„CZONE dla oszczÄ™dnoÅ›ci!
        dtype: "fp16"                     # ğŸ”½ fp16 zamiast bf16
        attention_mechanism: "xformers"   # âœ… Memory-efficient
        use_8bit_adam: true               # ğŸ”½ WÅÄ„CZONE dla oszczÄ™dnoÅ›ci
        gradient_checkpointing_text_encoder: true
        # NOWE - dodatkowe oszczÄ™dnoÅ›ci
        enable_sequential_cpu_offload: true     # ğŸ”½ CPU offload dla RAM
        enable_model_cpu_offload: true         # ğŸ”½ Model na CPU gdy nie uÅ¼ywany
        enable_attention_slicing: true         # ğŸ”½ Slice attention dla RAM

      # PrÃ³bki - MINIMALNE dla oszczÄ™dnoÅ›ci
      sample:
        sampler: "flowmatch"
        sample_every: 500                 # ğŸ”½ Rzadsze sampling
        width: 512                        # ğŸ”½ Najmniejsza rozdzielczoÅ›Ä‡
        height: 512                       # ğŸ”½ Kwadratowa dla oszczÄ™dnoÅ›ci
        guidance_scale: 3.5               # Lekko zredukowane
        sample_steps: 15                  # ğŸ”½ Mniej krokÃ³w dla szybkoÅ›ci
        seed: 42
        walk_seed: false                  # ğŸ”½ WyÅ‚Ä…czone dla oszczÄ™dnoÅ›ci
        # Minimalne prompts
        prompts:
          - "photo of Matt"               # Tylko podstawowy prompt
        neg: ""
        enable_attention_slicing: true    # ğŸ”½ Kluczowe dla RAM
        enable_sequential_cpu_offload: true  # ğŸ”½ CPU offload